{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["import {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\nimport {\n    component,\n    fontColorButtonName,\n    icon,\n} from './common';\n\nlet colorPickerContainer = null;\nlet isPickerVisible = false;\nlet clickHandler = null;\nlet isTyping = false;\nlet activityDetected = false;\nlet closeTimer = null;\n\n/**\n * Displays the color picker\n */\nconst showColorPicker = (editor, buttonTitle) => {\n\n    hideColorPicker();\n\n    // Creates the main container\n    colorPickerContainer = document.createElement('div');\n    colorPickerContainer.className = 'tiny-fontcolor-picker';\n    Object.assign(colorPickerContainer.style, {\n        position: 'fixed',\n        zIndex: '999999',\n        backgroundColor: 'white',\n        padding: '15px',\n        borderRadius: '8px',\n        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',\n        border: '1px solid #ddd',\n        width: '200px'\n    });\n\n    // Create input colour\n    const colorInput = document.createElement('input');\n    colorInput.type = 'color';\n    Object.assign(colorInput.style, {\n        width: '100%',\n        height: '50px',\n        cursor: 'pointer',\n        border: '2px solid #eee',\n        borderRadius: '6px',\n        padding: '2px',\n        display: 'block'\n    });\n\n\n    // set colour based on the initial/previous selection\n    const initialColor = getSelectionColor(editor);\n    if (initialColor) {\n        colorInput.value = rgbToHex(initialColor);\n    }\n\n\n    // Apply colour when changed\n    colorInput.addEventListener('input', (e) => {\n        editor.execCommand('ForeColor', false, e.target.value);\n    });\n\n     //User starts typing\n     colorInput.addEventListener('focus', () => {\n        isTyping = true;\n        resetCloseTimer();\n    });\n\n    // Finish typing\n    colorInput.addEventListener('input', () => {\n        activityDetected = true;\n        resetCloseTimer();\n    });\n\n    // Loose focus\n    colorInput.addEventListener('blur', () => {\n        isTyping = false;\n        resetCloseTimer();\n    });\n\n    //  typing\n    colorInput.addEventListener('keydown', () => {\n        isTyping = true;\n        activityDetected = true;\n        resetCloseTimer();\n    });\n\n    // Add colour picker to the container\n    colorPickerContainer.appendChild(colorInput);\n\n    // Add the container to the DOM\n    document.body.appendChild(colorPickerContainer);\n    isPickerVisible = true;\n\n    // Position the selector near the toolbar button\n    const button = editor.editorContainer.querySelector(`.tox-tbtn[aria-label=\"${buttonTitle}\"]`);\n    if (button) {\n        const rect = button.getBoundingClientRect();\n        Object.assign(colorPickerContainer.style, {\n            top: `${rect.bottom}px`,\n            left: `${rect.left}px`\n        });\n    }\n\n    // Focus the input\n    setTimeout(() => colorInput.focus(), 0);\n\n    // Close\n    clickHandler = (e) => {\n        if (colorPickerContainer && !colorPickerContainer.contains(e.target)) {\n            hideColorPicker();\n        }\n    };\n\n    document.addEventListener('mousedown', clickHandler);\n};\n\n\n\n\n/**\n * Get the colour of the selected text\n */\nfunction getSelectionColor(editor) {\n    if (!editor || !editor.dom || !editor.selection) return null;\n\n    const dom = editor.dom;\n    const selection = editor.selection;\n    const nodes = selection.getSelectedBlocks() || [selection.getNode()];\n\n    for (const node of nodes) {\n        if (!node) continue;\n\n        const color = dom.getStyle(node, 'color') || node.getAttribute('color');\n        if (color) return color;\n\n        const coloredChildren = dom.select('*[style*=\"color\"], *[color]', node);\n        if (coloredChildren?.length > 0) {\n            const childColor = dom.getStyle(coloredChildren[0], 'color') ||\n                             coloredChildren[0]?.getAttribute('color');\n            if (childColor) return childColor;\n        }\n    }\n    return null;\n}\n\n/**\n * Hide colour picker\n */\nconst hideColorPicker = () => {\n    if (colorPickerContainer && isPickerVisible) {\n        if (colorPickerContainer.parentNode) {\n            colorPickerContainer.parentNode.removeChild(colorPickerContainer);\n        }\n        colorPickerContainer = null;\n        isPickerVisible = false;\n\n        if (clickHandler) {\n            document.removeEventListener('mousedown', clickHandler);\n            clickHandler = null;\n        }\n    }\n\n    isTyping = false;\n    activityDetected = false;\n};\n\n/**\n * Turn  RGB a HEX\n */\nfunction rgbToHex(rgb) {\n    if (!rgb) return '#000000'; // Default black.\n\n    const rgbValues = rgb.match(/\\d+/g);\n    if (!rgbValues || rgbValues.length < 3) return '#000000';\n\n    const r = parseInt(rgbValues[0]);\n    const g = parseInt(rgbValues[1]);\n    const b = parseInt(rgbValues[2]);\n\n    return '#' + [r, g, b].map(x => {\n        const hex = x.toString(16).padStart(2, '0');\n        return hex.length === 1 ? '0' + hex : hex;\n    }).join('');\n}\n\nfunction resetCloseTimer() {\n    clearTimeout(closeTimer);\n\n    if (isPickerVisible && colorPickerContainer) {\n        closeTimer = setTimeout(() => {\n            if (!activityDetected && !isTyping) {\n                hideColorPicker();\n            } else {\n                activityDetected = false;\n                resetCloseTimer();\n            }\n        }, isTyping ? 3000 : 1500);\n    }\n}\n\n/**\n * Plugin configuration\n */\nexport const getSetup = async () => {\n    const [buttonTitle, menuTitle, btnImage] = await Promise.all([\n        getString('button_fontcolor', component),\n        getString('menuitem_fontcolor', component),\n        getButtonImage('icon', component)\n    ]);\n\n    return (editor) => {\n        editor.ui.registry.addIcon(icon, btnImage.html);\n\n        editor.ui.registry.addButton(fontColorButtonName, {\n            icon,\n            tooltip: buttonTitle,\n            onAction: () => {\n                if (isPickerVisible) {\n                    hideColorPicker();\n                } else {\n                    showColorPicker(editor, buttonTitle);\n                }\n            }\n        });\n\n        editor.on('blur', hideColorPicker);\n    };\n};"],"names":["colorPickerContainer","isPickerVisible","clickHandler","isTyping","activityDetected","closeTimer","showColorPicker","editor","buttonTitle","hideColorPicker","document","createElement","className","Object","assign","style","position","zIndex","backgroundColor","padding","borderRadius","boxShadow","border","width","colorInput","type","height","cursor","display","initialColor","dom","selection","nodes","getSelectedBlocks","getNode","node","color","getStyle","getAttribute","coloredChildren","select","length","childColor","_coloredChildren$","getSelectionColor","value","rgb","rgbValues","match","r","parseInt","g","b","map","x","hex","toString","padStart","join","rgbToHex","addEventListener","e","execCommand","target","resetCloseTimer","appendChild","body","button","editorContainer","querySelector","rect","getBoundingClientRect","top","bottom","left","setTimeout","focus","contains","parentNode","removeChild","removeEventListener","clearTimeout","async","menuTitle","btnImage","Promise","all","component","ui","registry","addIcon","icon","html","addButton","fontColorButtonName","tooltip","onAction","on"],"mappings":"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"}